@model IEnumerable<PawsAndClaws.Models.ViewModels.PetCardViewModel>

@if (TempData["SuccessMessage"] != null)
{
    <p class="mt-2 text-sm font-semibold text-green-600">@TempData["SuccessMessage"]</p>
}
@if (TempData["AddPetError"] != null)
{
    <p class="mt-2 text-sm font-semibold text-red-600">@TempData["AddPetError"]</p>
}


@{
    Layout = "_Layout";
    ViewData["Title"] = "Pet Inventory";
    ViewData["IsAdmin"] = true;
    
    // Calculate status counts and create filter model
    var statusCounts = new Dictionary<string, int>
    {
        { "All", Model.Count() },
        { "Available", Model.Count(p => p.Status == "Available") },
        { "Pending", Model.Count(p => p.Status == "Pending") },
        { "Adopted", Model.Count(p => p.Status == "Adopted") }
    };
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header Section -->
    <div class="mb-10 flex items-start justify-between gap-8">
        <div>
            <h1 class="text-4xl font-black text-[#2D2D2D] mb-2" style="font-family: 'Lilita One', cursive;">
                <span class="text-[#F87004]">Pet </span><span class="text-[#56C2B1]">Inventory</span>
            </h1>
            <p class="text-gray-600 font-medium">Manage all pets currently listed in the shelter.</p>
        </div>

        <!-- Add New Pet Button (Top Right) -->
        <button onclick="openAddPetModal()" 
                class="px-8 py-4 rounded-full text-xs font-bold uppercase tracking-widest bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white shadow-md shadow-orange-100 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2 whitespace-nowrap mt-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Add Pet
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
        <div class="relative">
            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
            <input type="text" 
                   id="searchInput"
                   placeholder="Search name or breed..." 
                   class="w-full pl-12 pr-6 py-4 bg-gray-50 border border-gray-200 rounded-full text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#56C2B1]/20 focus:border-[#56C2B1] transition-all" 
                   onkeyup="filterPets()" />
        </div>
    </div>

    <!-- Filter Section with Count -->
    <div class="mb-8 flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-2">
            <h3 class="text-lg font-bold text-[#2D2D2D]">All Pets</h3>
            <span class="bg-[#F87004] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" id="petCount">
                @Model.Count()
            </span>
        </div>

        <!-- Filter Group - Custom buttons for client-side filtering -->
        <div class="flex bg-gray-100/50 p-1.5 rounded-full border border-gray-100">
            <button type="button" onclick="filterByStatus('All')" class="filter-btn px-6 py-2 text-xs font-bold rounded-full transition-all no-underline flex items-center gap-2 bg-[#F87004] text-white shadow-sm" data-status="All">
                All <span class="text-[10px] opacity-70">(@statusCounts["All"])</span>
            </button>
            <button type="button" onclick="filterByStatus('Available')" class="filter-btn px-6 py-2 text-xs font-bold rounded-full transition-all text-gray-400 hover:text-gray-600" data-status="Available">
                Available <span class="text-[10px] opacity-70">(@statusCounts["Available"])</span>
            </button>
            <button type="button" onclick="filterByStatus('Pending')" class="filter-btn px-6 py-2 text-xs font-bold rounded-full transition-all text-gray-400 hover:text-gray-600" data-status="Pending">
                Pending <span class="text-[10px] opacity-70">(@statusCounts["Pending"])</span>
            </button>
            <button type="button" onclick="filterByStatus('Adopted')" class="filter-btn px-6 py-2 text-xs font-bold rounded-full transition-all text-gray-400 hover:text-gray-600" data-status="Adopted">
                Adopted <span class="text-[10px] opacity-70">(@statusCounts["Adopted"])</span>
            </button>
        </div>
    </div>

    <!-- Pet Grid -->
    <div id="petGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        @foreach (var pet in Model)
        {
            <partial name="_PetCard" model="pet" />
        }
    </div>
</div>

<partial name="_AddPetModal" model="new PawsAndClaws.Models.ViewModels.AddPetViewModel()" />
<partial name="_EditPetModal" model="new PawsAndClaws.Models.Entities.Pet()" />

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="csrfToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

<script>
    // ==================== STATE ====================
    let currentStatusFilter = "All";

    // ==================== HELPERS ====================
    function csrfToken() {
      return document.getElementById("csrfToken")?.value || "";
    }

    function qs(sel, root = document) {
      return root.querySelector(sel);
    }

    // ==================== MODALS ====================
    function openAddPetModal() {
      qs("#addPetModal")?.classList.remove("hidden");
    }

    function closeAddPetModal() {
      qs("#addPetModal")?.classList.add("hidden");
    }

    function closeEditPetModal() {
      qs("#editPetModal")?.classList.add("hidden");
    }

    // ==================== INIT ====================
    document.addEventListener("DOMContentLoaded", () => {
      // Open Add modal if ?add=1
      const params = new URLSearchParams(window.location.search);
      if (params.get("add") === "1") openAddPetModal();

      // Lucide icons init
      if (typeof lucide !== "undefined") lucide.createIcons();
    });

    // Close modals when clicking backdrop
    document.addEventListener("click", (event) => {
      const addModal = qs("#addPetModal");
      if (addModal && event.target === addModal) closeAddPetModal();

      const editModal = qs("#editPetModal");
      if (editModal && event.target === editModal) closeEditPetModal();
    });

    // ==================== FILTER STATUS ====================
    function filterByStatus(status) {
      currentStatusFilter = status;

      document.querySelectorAll(".filter-btn").forEach((btn) => {
        const isActive = btn.getAttribute("data-status") === status;
        if (isActive) {
          btn.classList.remove("text-gray-400", "hover:text-gray-600");
          btn.classList.add("bg-[#F87004]", "text-white", "shadow-sm");
        } else {
          btn.classList.add("text-gray-400", "hover:text-gray-600");
          btn.classList.remove("bg-[#F87004]", "text-white", "shadow-sm");
        }
      });

      filterPets();
    }

    // ==================== FILTER + SEARCH ====================
    function filterPets() {
      const searchInput = (qs("#searchInput")?.value || "").toLowerCase();
      const petCards = document.querySelectorAll(".pet-card");
      let visibleCount = 0;

      petCards.forEach((card) => {
        const name = (card.getAttribute("data-name") || "").toLowerCase();
        const breed = (card.getAttribute("data-breed") || "").toLowerCase();
        const status = (card.getAttribute("data-status") || "").toLowerCase();

        const matchesSearch = name.includes(searchInput) || breed.includes(searchInput);
        const matchesStatus =
          currentStatusFilter === "All" || status === currentStatusFilter.toLowerCase();

        if (matchesSearch && matchesStatus) {
          card.style.display = "";
          visibleCount++;
        } else {
          card.style.display = "none";
        }
      });

      const countEl = qs("#petCount");
      if (countEl) countEl.textContent = String(visibleCount);
    }

    // ==================== ADMIN: EDIT ====================
    async function openEditPetModal(petId) {
      try {
        const res = await fetch(`/Pet/GetPetData/${petId}`, {
          method: "GET",
          credentials: "same-origin",
          headers: { "Accept": "application/json" }
        });

        if (!res.ok) {
          const raw = await res.text();
          console.error("GetPetData failed:", res.status, raw);
          alert("Failed to load pet data");
          return;
        }

        const data = await res.json();

        const modalEl = qs("#editPetModal");
        const formEl = qs("#editPetForm");

        if (!modalEl || !formEl) {
          console.error("Edit modal or form not found (#editPetModal / #editPetForm).");
          alert("Edit modal not found.");
          return;
        }

        const setVal = (name, value) => {
          const el = modalEl.querySelector(`[name="${name}"]`);
          if (el) el.value = value ?? "";
        };

        // ✅ required hidden fields in your modal
        setVal("Id", data.id ?? petId);
        setVal("ExistingImageUrl", data.imageUrl ?? "");

        // ✅ visible fields
        setVal("Name", data.name);
        setVal("Breed", data.breed);
        setVal("Age", data.age);
        setVal("Size", data.size);
        setVal("Gender", data.gender);
        setVal("Species", data.species);
        setVal("Location", data.location);
        setVal("Description", data.description);

        // keep your existing route style
        formEl.action = `/Pet/EditPet/${petId}`;
        formEl.method = "post";

        modalEl.classList.remove("hidden");

        if (typeof lucide !== "undefined") lucide.createIcons();
      } catch (err) {
        console.error("Error fetching pet data:", err);
        alert("Failed to load pet data");
      }
    }

    // ==================== ADMIN: DELETE ====================
    async function deletePet(petId) {
      if (!confirm("Are you sure you want to delete this pet?")) return;

      try {
        const res = await fetch(`/Pet/DeletePet/${petId}`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "RequestVerificationToken": csrfToken()
          }
        });

        if (!res.ok) {
          const raw = await res.text();
          console.error("DeletePet failed:", res.status, raw);
          alert("Failed to delete pet");
          return;
        }

        // Remove from UI
        document.querySelector(`.pet-card[data-pet-id="${petId}"]`)?.remove();
        filterPets();
      } catch (err) {
        console.error("Error deleting pet:", err);
        alert("Error deleting pet");
      }
    }
</script>