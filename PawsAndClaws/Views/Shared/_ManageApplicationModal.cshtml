@model PawsAndClaws.Models.ViewModels.ApplicationCardViewModel

@{
    var modalId = $"manageApplicationModal-{Model.ApplicationId}";
    var formId = $"manageAppForm-{Model.ApplicationId}";
    var currentStatus = (Model.Status ?? "").Trim().ToUpperInvariant();
    var isAdopted = currentStatus == "ADOPTED";

    var statuses = new[] {
        new { Value = "REVIEW",     Label = "Review" },
        new { Value = "PENDING",    Label = "Pending" },
        new { Value = "APPROVED",   Label = "Approved" },
        new { Value = "ADOPTED",    Label = "Adopted" },
        new { Value = "REJECTED",   Label = "Rejected" }
    };

    var stageLabels = new[] { "Application", "Pre-approved", "Final Interview", "Ready to Go" };
}

<div id="@modalId" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4">
    <div class="bg-white rounded-[40px] w-full max-w-2xl shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden animate-in fade-in zoom-in duration-300">

        <div class="p-8 pb-4 flex justify-between items-center border-b border-gray-50 shrink-0">
            <h2 class="text-3xl font-black text-[#2D2D2D]" style="font-family: 'Lilita One', cursive;">
                Manage <span class="text-[#56C2B1]">Application</span>
            </h2>

            <button type="button" data-close-manage-modal class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form id="@formId"
              asp-controller="Adoption" asp-action="UpdateApplicationStatus"
              method="post"
              class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">

            @Html.AntiForgeryToken()

            <input type="hidden" name="ApplicationId" value="@Model.ApplicationId" />
            <input type="hidden" name="CurrentStep" class="js-stage-input" value="@Model.CurrentStep" />
            <input type="hidden" name="Status" class="js-status-input" value="@currentStatus" />

            <div class="p-8 space-y-8 flex-1">

                <div class="bg-gray-50 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <img src="@Model.ImageUrl" alt="@Model.PetName" class="w-20 h-20 rounded-full object-cover" />
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-[#2D2D2D]">@Model.ApplicantName</h3>
                            <p class="text-gray-500 text-sm uppercase tracking-widest">Applying for @Model.PetName</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                                Date Applied
                            </div>
                            <div class="text-sm font-semibold text-[#2D2D2D]">
                                @(string.IsNullOrWhiteSpace(Model.DateApplied) ? "—" : Model.DateApplied)
                            </div>
                        </div>
                    </div>
                </div>

                @* Message *@
                <div class="mt-4">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                        Applicant Message
                    </div>
                    <p class="text-sm text-gray-600 leading-relaxed">
                        @(string.IsNullOrWhiteSpace(Model.ApplicationMessage) ? "—" : Model.ApplicationMessage)
                    </p>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] font-black text-gray-400 tracking-widest uppercase">Application Status</label>

                    <div class="flex bg-white border border-gray-100 rounded-full p-1 shadow-sm w-full">
                        @foreach (var s in statuses)
                        {
                            var isCurrent = string.Equals(currentStatus, s.Value, StringComparison.OrdinalIgnoreCase);

                            <button type="button"
                                    data-status="@s.Value"
                                    class="status-btn px-6 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all duration-300 flex-1
                                           @(isCurrent
                                                ? "bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white shadow-md shadow-orange-100"
                                                : "text-gray-400 hover:text-gray-600 hover:bg-gray-50")">
                                @s.Label
                            </button>
                        }
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] font-black text-gray-400 tracking-widest uppercase">Progress Stage</label>

                    <div class="grid grid-cols-2 gap-4">
                        @for (int i = 1; i <= 4; i++)
                        {
                            // Logic:
                            // 1. If Adopted, everything is COMPLETED (Green).
                            // 2. Else: < Current is COMPLETED (Green).
                            // 3. Else: == Current is CURRENT (Orange).
                            
                            bool isCompleted = isAdopted || (i < Model.CurrentStep);
                            bool isCurrent = !isAdopted && (i == Model.CurrentStep);

                            <button type="button" data-stage="@i"
                                    class="stage-card border-2 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300
                                           @(isCompleted ? "border-[#50B442] bg-[#50B442]/5"     // Green
                                            : isCurrent ? "border-[#F87004] bg-[#F87004]/5"      // Orange
                                            : "border-gray-200 bg-gray-50")">

                                <div class="stage-icon-container w-10 h-10 rounded-full flex items-center justify-center transition-all
                                            @(isCompleted ? "bg-[#50B442]"                       // Green Fill
                                            : isCurrent ? "border-2 border-[#F87004]"            // Orange Border
                                            : "border-2 border-gray-300")">
                                    @if (isCompleted)
                                    {
                                        <i data-lucide="check" class="w-5 h-5 text-white"></i>
                                    }
                                    else if (isCurrent)
                                    {
                                        <div class="stage-dot w-4 h-4 rounded-full bg-[#F87004]"></div> }
                                    else
                                    {
                                        <div class="stage-dot w-3 h-3 rounded-full bg-gray-300"></div>
                                    }
                                </div>

                                <div class="text-center">
                                    <p class="stage-label-sm text-[10px] font-black uppercase tracking-widest 
                                              @(isCompleted ? "text-[#50B442]" 
                                              : isCurrent ? "text-[#F87004]" 
                                              : "text-gray-400")">
                                        Stage @i
                                    </p>
                                    <p class="stage-label-lg text-sm font-bold 
                                              @(isCompleted ? "text-[#50B442]" 
                                              : isCurrent ? "text-[#F87004]" 
                                              : "text-gray-400")">
                                        @stageLabels[i - 1]
                                    </p>
                                </div>
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-50 p-8 bg-white flex gap-4 shrink-0">
                <button type="button" data-close-manage-modal
                        class="flex-1 px-6 py-3 border-2 border-red-500 text-red-500 rounded-full font-bold uppercase tracking-widest hover:bg-red-50 transition-colors text-sm">
                    Cancel
                </button>

                <button type="submit"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white rounded-full font-bold uppercase tracking-widest shadow-lg shadow-orange-100 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-sm">
                    Save Changes
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('@modalId');
      if (!modal) return;

      const closeBtns  = modal.querySelectorAll('[data-close-manage-modal]');
      const statusBtns = modal.querySelectorAll('.status-btn');
      const stageCards = modal.querySelectorAll('.stage-card');
      const statusInput = modal.querySelector('.js-status-input');
      const stageInput  = modal.querySelector('.js-stage-input');

      // Helper to redraw stages based on current selection AND status
      function updateStageVisuals() {
        // 1. Check if Status is ADOPTED
        const isAdopted = (statusInput.value === "ADOPTED");
        const currentStageVal = parseInt(stageInput.value || "1", 10);

        stageCards.forEach(card => {
          const idx = parseInt(card.dataset.stage || "1", 10);
          const icon = card.querySelector('.stage-icon-container');
          const sm   = card.querySelector('.stage-label-sm');
          const lg   = card.querySelector('.stage-label-lg');
          if (!icon || !sm || !lg) return;

          // Logic for visual state
          let state = 'future'; 
          if (isAdopted) {
             state = 'completed'; // Force Green if Adopted
          } else {
             if (idx < currentStageVal) state = 'completed';
             else if (idx === currentStageVal) state = 'current';
             else state = 'future';
          }

          // Apply Styles
          if (state === 'completed') {
            // GREEN STYLE
            card.className = "stage-card border-2 border-[#50B442] bg-[#50B442]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
            sm.className = "stage-label-sm text-[10px] font-black text-[#50B442] uppercase tracking-widest";
            lg.className = "stage-label-lg text-sm font-bold text-[#50B442]";
            icon.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center bg-[#50B442]";
            icon.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';

          } else if (state === 'current') {
            // ORANGE STYLE (Restored)
            card.className = "stage-card border-2 border-[#F87004] bg-[#F87004]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
            sm.className = "stage-label-sm text-[10px] font-black text-[#F87004] uppercase tracking-widest";
            lg.className = "stage-label-lg text-sm font-bold text-[#F87004]";
            icon.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-[#F87004]";
            icon.innerHTML = '<div class="w-4 h-4 rounded-full bg-[#F87004]"></div>';

          } else {
            // GRAY STYLE
            card.className = "stage-card border-2 border-gray-200 bg-gray-50 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
            sm.className = "stage-label-sm text-[10px] font-black text-gray-400 uppercase tracking-widest";
            lg.className = "stage-label-lg text-sm font-bold text-gray-400";
            icon.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300";
            icon.innerHTML = '<div class="w-3 h-3 rounded-full bg-gray-300"></div>';
          }
        });

        if (window.lucide) lucide.createIcons();
      }

      // Close Modal Logic
      const closeModal = () => modal.classList.add('hidden');
      closeBtns.forEach(b => b.addEventListener('click', closeModal));
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      // STATUS CLICK HANDLER
      statusBtns.forEach(btn => {
        btn.addEventListener('click', function () {
          // Update visual buttons
          statusBtns.forEach(b => {
            b.classList.remove('bg-gradient-to-r','from-[#F87004]','to-[#FFB347]','text-white','shadow-md','shadow-orange-100');
            b.classList.add('text-gray-400','hover:text-gray-600','hover:bg-gray-50');
          });
          this.classList.remove('text-gray-400','hover:text-gray-600','hover:bg-gray-50');
          this.classList.add('bg-gradient-to-r','from-[#F87004]','to-[#FFB347]','text-white','shadow-md','shadow-orange-100');

          // Set hidden input
          const val = (this.dataset.status || "").toUpperCase();
          if (statusInput) statusInput.value = val;

          // Update stages immediately
          updateStageVisuals();
        });
      });

      // STAGE CLICK HANDLER
      stageCards.forEach(card => {
        card.addEventListener('click', function () {
          const selectedIdx = parseInt(this.dataset.stage || "1", 10);
          if (stageInput) stageInput.value = selectedIdx;
          updateStageVisuals();
        });
      });
    });
</script>