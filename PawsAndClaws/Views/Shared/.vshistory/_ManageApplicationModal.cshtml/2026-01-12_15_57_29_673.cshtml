@model PawsAndClaws.Models.ViewModels.ApplicationCardViewModel

<div id="manageApplicationModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4">
    <div class="bg-white rounded-[40px] w-full max-w-2xl shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden animate-in fade-in zoom-in duration-300">
        
        @* 1. FIXED HEADER: Preserves Teal branding *@
        <div class="p-8 pb-4 flex justify-between items-center border-b border-gray-50 shrink-0">
            <h2 class="text-3xl font-black text-[#2D2D2D]" style="font-family: 'Lilita One', cursive;">
                Manage <span class="text-[#56C2B1]">Application</span>
            </h2>
            <button id="closeManageApplicationModal" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-400">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        @* 2. SCROLLABLE FORM CONTENT: 'custom-scrollbar' handles the "inside" bar styling *@
        <form asp-controller="Adoption" asp-action="UpdateApplicationStatus" method="post" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
            @* BACKEND DATA: Hidden inputs to track state changes for POST submission *@
            <input type="hidden" name="CurrentStep" id="selectedStageInput" value="@Model.CurrentStep" />
            <input type="hidden" name="Status" id="selectedStatusInput" value="@Model.Status" />

            <div class="p-8 space-y-8 flex-1">
                @* Applicant Profile Summary *@
                <div class="bg-gray-50 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <img src="@Model.ImageUrl" alt="@Model.PetName" class="w-20 h-20 rounded-full object-cover" />
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-[#2D2D2D]">Dan Louie</h3>
                            <p class="text-gray-500 text-sm uppercase tracking-widest">Applying for @Model.PetName</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Date Applied</p>
                            <p class="text-lg font-bold text-[#2D2D2D]">JAN 09, 2026</p>
                        </div>
                    </div>
                </div>

                @* SELECTABLE STATUS SECTION: Swaps between gray and orange gradient *@
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-gray-400 tracking-widest uppercase">Application Status</label>
                    <div class="flex bg-white border border-gray-100 rounded-full p-1 shadow-sm w-full" id="statusButtonGroup">
                        @foreach (var status in new[] { "Review", "Pending", "Rejected" })
                        {
                            bool isCurrentStatus = string.Equals(Model.Status, status, StringComparison.OrdinalIgnoreCase);

                            <button type="button" data-status="@status"
                                    class="status-btn px-6 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all duration-300 flex-1
                    @(isCurrentStatus
                                                        ? "bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white shadow-md shadow-orange-100"
                                                        : "text-gray-400 hover:text-gray-600 hover:bg-gray-50")">
                                @status
                            </button>
                        }
                    </div>
                </div>

                @* SELECTABLE STAGE SECTION: Green (#50B442) vs Orange (#F87004) *@
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-gray-400 tracking-widest uppercase">Progress Stage</label>
                    <div class="grid grid-cols-2 gap-4" id="stageGrid">
                        @{
                            var stageLabels = new[] { "Application", "Pre-approved", "Final Interview", "Ready to Go" };
                            for (int i = 1; i <= 4; i++)
                            {
                                bool isCompleted = i < Model.CurrentStep;
                                bool isCurrent = i == Model.CurrentStep;

                                <button type="button" data-stage="@i"
                                        class="stage-card border-2 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300
                                        @(isCompleted ? "border-[#50B442] bg-[#50B442]/5" : isCurrent ? "border-[#F87004] bg-[#F87004]/5" : "border-gray-200 bg-gray-50")">
                                    
                                    <div class="stage-icon-container w-10 h-10 rounded-full flex items-center justify-center transition-all
                                        @(isCompleted ? "bg-[#50B442]" : isCurrent ? "border-2 border-[#F87004]" : "border-2 border-gray-300")">
                                        @if (isCompleted) { <i data-lucide="check" class="w-5 h-5 text-white"></i> }
                                        else { <div class="stage-dot w-3 h-3 rounded-full @(isCurrent ? "bg-[#F87004]" : "bg-gray-300")"></div> }
                                    </div>

                                    <div class="text-center">
                                        <p class="stage-label-sm text-[10px] font-black uppercase tracking-widest @(isCompleted ? "text-[#50B442]" : isCurrent ? "text-[#F87004]" : "text-gray-400")">Stage @i</p>
                                        <p class="stage-label-lg text-sm font-bold @(isCompleted ? "text-[#50B442]" : isCurrent ? "text-[#F87004]" : "text-gray-400")">@stageLabels[i-1]</p>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            @* 3. STICKY FOOTER: Pinned to the bottom of the modal *@
            <div class="border-t border-gray-50 p-8 bg-white flex gap-4 shrink-0">
                <button type="button" id="cancelManageApplicationBtn" 
                        class="flex-1 px-6 py-3 border-2 border-red-500 text-red-500 rounded-full font-bold uppercase tracking-widest hover:bg-red-50 transition-colors text-sm">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white rounded-full font-bold uppercase tracking-widest shadow-lg shadow-orange-100 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-sm">
                    Save Changes
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #F1F3F5; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #50B442; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('manageApplicationModal');
        const closeBtn = document.getElementById('closeManageApplicationModal');
        const cancelBtn = document.getElementById('cancelManageApplicationBtn');
        const statusBtns = document.querySelectorAll('.status-btn');
        const statusInput = document.getElementById('selectedStatusInput');
        const stageCards = document.querySelectorAll('.stage-card');
        const stageInput = document.getElementById('selectedStageInput');

        // MODAL CLOSE HANDLERS
        const closeModal = () => {
            modal.classList.add('hidden');
        };

        closeBtn?.addEventListener('click', closeModal);
        cancelBtn?.addEventListener('click', closeModal);
        
        // Close when clicking outside (on backdrop)
        modal?.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // 1. SELECTABLE STATUS LOGIC
        statusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Reset all to gray state
                statusBtns.forEach(b => {
                    b.classList.remove('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');
                    b.classList.add('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');
                });
                // Set clicked to active orange
                this.classList.remove('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');
                this.classList.add('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');
                statusInput.value = this.getAttribute('data-status');
            });
        });

        // 2. SEQUENTIAL STAGE LOGIC: Green for past, Orange for current
        stageCards.forEach(card => {
            card.addEventListener('click', function() {
                const selectedIdx = parseInt(this.getAttribute('data-stage'));
                stageInput.value = selectedIdx;

                stageCards.forEach(otherCard => {
                    const currentIdx = parseInt(otherCard.getAttribute('data-stage'));
                    const iconContainer = otherCard.querySelector('.stage-icon-container');
                    const labelSm = otherCard.querySelector('.stage-label-sm');
                    const labelLg = otherCard.querySelector('.stage-label-lg');
                    
                    if (currentIdx < selectedIdx) {
                        // GREEN: Completed
                        otherCard.className = "stage-card border-2 border-[#50B442] bg-[#50B442]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                        labelSm.className = "stage-label-sm text-[10px] font-black text-[#50B442] uppercase tracking-widest";
                        labelLg.className = "stage-label-lg text-sm font-bold text-[#50B442]";
                        iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center bg-[#50B442]";
                        iconContainer.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';
                    } else if (currentIdx === selectedIdx) {
                        // ORANGE: Active
                        otherCard.className = "stage-card border-2 border-[#F87004] bg-[#F87004]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                        labelSm.className = "stage-label-sm text-[10px] font-black text-[#F87004] uppercase tracking-widest";
                        labelLg.className = "stage-label-lg text-sm font-bold text-[#F87004]";
                        iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-[#F87004]";
                        iconContainer.innerHTML = '<div class="w-4 h-4 rounded-full bg-[#F87004]"></div>';
                    } else {
                        // GRAY: Inactive
                        otherCard.className = "stage-card border-2 border-gray-200 bg-gray-50 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                        labelSm.className = "stage-label-sm text-[10px] font-black text-gray-400 uppercase tracking-widest";
                        labelLg.className = "stage-label-lg text-sm font-bold text-gray-400";
                        iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300";
                        iconContainer.innerHTML = '<div class="w-3 h-3 rounded-full bg-gray-300"></div>';
                    }
                });
                if (window.lucide) lucide.createIcons();
            });
        });

        // Handle form submission with confirmation
        const manageForm = document.querySelector('form[asp-controller="Adoption"][asp-action="UpdateApplicationStatus"]');
        if (manageForm) {
            const originalSubmit = manageForm.onsubmit;
            manageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const selectedStatus = document.getElementById('selectedStatusInput').value;
                const selectedStage = document.getElementById('selectedStageInput').value;
                
                let statusMessage = '';
                if (selectedStatus === 'Rejected') {
                    statusMessage = 'This application will be marked as REJECTED.';
                } else if (selectedStatus === 'Pending') {
                    statusMessage = `This application will move to stage ${selectedStage}.`;
                } else if (selectedStatus === 'Review') {
                    statusMessage = 'This application will be put back in REVIEW.';
                }

                ModalManager.confirm(
                    "Update application?",
                    statusMessage + " This action cannot be undone immediately.",
                    "UPDATE",
                    "CANCEL",
                    () => {
                        // Show success message
                        ModalManager.show(
                            "Updated!",
                            "The application status has been updated successfully.",
                            "OKAY",
                            () => {
                                manageForm.submit();
                            }
                        );
                    },
                    () => {
                        // Do nothing if cancelled
                    }
                );
            });
        }
    });
</script>