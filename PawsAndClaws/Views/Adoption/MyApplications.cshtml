@model PawsAndClaws.Models.ViewModels.ApplicationPageViewModel

@{
    ViewData["Title"] = "My Applications";
}

@* --- Flash Message Area --- *@
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 rounded-2xl border border-green-200 bg-green-50 px-5 py-4 text-green-800 text-sm font-semibold shadow-sm">
        @TempData["SuccessMessage"]
    </div>
}

<div class="bg-[#FFFAF7] min-h-screen pb-20 font-sans">
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        @* --- Header Section --- *@
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-16 gap-6">
            <div>
                <h1 class="text-6xl font-bold text-[#2D2D2D] font-lilita" style="font-family: 'Lilita One', cursive;">
                    <span class="text-[#F87004]">Welcome</span> <span class="text-[#56C2B1]">back,</span> @Model.UserName!
                </h1>
                <p class="text-gray-500 font-medium mt-2">Track the progress of your applications and manage your shelter visits.</p>
            </div>

            @* --- Shelter Visit Card Partial --- *@
            @if (Model.Visits != null && Model.Visits.Any())
            {
                <partial name="_ShelterVisitCard" model="Model.Visits.FirstOrDefault()" />
            }
        </div>

        @* --- Applications Grid Section --- *@
        <div class="mb-20">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-bold text-[#2D2D2D] flex items-center gap-3">
                    Your Applications 
                    @if(Model.StatusCounts != null && Model.StatusCounts.ContainsKey("All"))
                    {
                        <span class="bg-[#F87004] text-white text-xs px-3 py-2 rounded-full">@Model.StatusCounts["All"]</span>
                    }
                </h2>
                @* --- Filter Partial --- *@
                <partial name="_ApplicationFilter" model='Model.StatusCounts' />
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                @if (Model.Applications != null)
                {
                    foreach (var app in Model.Applications) 
                    {
                        @* Ensure _ApplicationCard contains a button with class 'cancel-application-btn', data-application-id, and data-pet-name *@
                        <partial name="_ApplicationCard" model="app" />
                    }
                }
            </div>
        </div>

    </div>
</div>

@* --- Cancellation Modal --- *@
<div id="cancelAppModal" 
     class="fixed inset-0 z-[99999] hidden items-center justify-center bg-black/40 backdrop-blur-sm px-4"
     aria-hidden="true">
    
    <div class="relative z-[100000] bg-white rounded-[32px] w-full max-w-md shadow-2xl overflow-hidden transform transition-all">
       
        @* Modal Header *@
        <div class="p-7 border-b border-gray-50 flex items-center justify-between">
            <h3 class="text-xl font-black text-[#2D2D2D]" style="font-family:'Lilita One', cursive;">
                Cancel <span class="text-[#F87004]">application</span>?
            </h3>
            <button type="button" id="cancelAppClose" class="p-2 hover:bg-gray-100 rounded-full text-gray-400 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        @* Modal Body *@
        <div class="p-7 text-sm text-gray-600 font-medium">
            Are you sure you want to cancel your application for 
            <span id="cancelAppPetName" class="font-bold text-[#2D2D2D]">this pet</span>?
        </div>

        @* Modal Footer/Actions *@
        <div class="p-7 pt-0 flex gap-3">
            <button type="button" id="cancelAppNo" 
                    class="flex-1 py-3 rounded-full border border-gray-200 text-gray-500 text-xs font-black uppercase tracking-widest hover:bg-gray-50 transition-colors">
                No, keep it
            </button>

            <button type="button" id="cancelAppYes" 
                    class="flex-1 py-3 rounded-full bg-gradient-to-r from-[#F87004] to-[#FBBF24] text-white text-xs font-black uppercase tracking-widest shadow-lg shadow-orange-100 hover:shadow-orange-200 transition-all">
                Yes, cancel
            </button>
        </div>
    </div>
</div>

@* --- Hidden Anti-Forgery Form --- *@
<form id="antiForgeryForm" class="hidden">
    @Html.AntiForgeryToken()
</form>

@* --- Scripts --- *@
<script>
    document.addEventListener("DOMContentLoaded", () => {
        
        // Initialize Lucide icons if the library is loaded
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        const cancelEndpoint = '@Url.Action("CancelApplication", "Adoption")';
        
        // DOM Elements
        const cancelModal = document.getElementById("cancelAppModal");
        const cancelPetName = document.getElementById("cancelAppPetName");
        const btnClose = document.getElementById("cancelAppClose");
        const btnNo = document.getElementById("cancelAppNo");
        const btnYes = document.getElementById("cancelAppYes");
        
        let pendingCancelAppId = null;

        // --- Helper Functions ---
        function getAntiForgeryToken() {
            return document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value || "";
        }

        function closeAllDropdowns() {
            document.querySelectorAll(".dropdown-menu").forEach(m => m.classList.add("hidden"));
        }

        function openCancelModal(appId, petName) {
            pendingCancelAppId = appId;
            if (cancelPetName) cancelPetName.textContent = petName || "this pet";
            
            // Show modal: remove hidden, add flex
            cancelModal?.classList.remove("hidden");
            cancelModal?.classList.add("flex");
        }

        function closeCancelModal() {
            pendingCancelAppId = null;
            // Hide modal: add hidden, remove flex
            cancelModal?.classList.add("hidden");
            cancelModal?.classList.remove("flex");
        }

        // --- Event Listeners ---

        // 1. Close Buttons (X and No)
        btnClose?.addEventListener("click", closeCancelModal);
        btnNo?.addEventListener("click", closeCancelModal);

        // 2. Close on Backdrop Click
        cancelModal?.addEventListener("click", (e) => {
            if (e.target === cancelModal) closeCancelModal();
        });

        // 3. Open Modal Delegate (handles clicks on .cancel-application-btn anywhere in DOM)
        document.addEventListener("click", (e) => {
            // Find the closest element with the class 'cancel-application-btn'
            const btn = e.target.closest(".cancel-application-btn");
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation(); // Stop bubbling
            closeAllDropdowns();

            const rawId = btn.dataset.applicationId; 
            const petName = btn.dataset.petName;

            console.log("Cancel clicked for ID:", rawId);

            if (!rawId) {
                console.error("Missing data-application-id on button.");
                return;
            }

            openCancelModal(rawId, petName);
        });

        // 4. Confirm Cancellation (YES Button)
        btnYes?.addEventListener("click", async () => {
            if (!pendingCancelAppId) return;

            // Visual feedback - disable button while processing
            const originalText = btnYes.innerText;
            btnYes.innerText = "Processing...";
            btnYes.disabled = true;

            const token = getAntiForgeryToken();
            
            // Build Form Data
            const body = new URLSearchParams();
            body.append("id", pendingCancelAppId);
            body.append("__RequestVerificationToken", token);

            try {
                const res = await fetch(cancelEndpoint, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" 
                    },
                    body: body.toString()
                });

                if (res.ok) {
                    // Success: Set local storage for filter and reload
                    closeCancelModal();
                    localStorage.setItem("applicationsFilter", "CANCELLED");
                    location.reload();
                } else {
                    const rawText = await res.text();
                    alert("Unable to cancel application. Please try again.");
                    console.error("Cancel Failed:", res.status, rawText);
                    
                    // Reset button state
                    btnYes.innerText = originalText;
                    btnYes.disabled = false;
                }
            } catch (err) {
                console.error("Fetch error:", err);
                alert("A network error occurred.");
                btnYes.innerText = originalText;
                btnYes.disabled = false;
            }
        });

        // 5. Restore Filter State on Reload
        const remembered = localStorage.getItem("applicationsFilter");
        if (remembered) {
            localStorage.removeItem("applicationsFilter");
            // Check if your filter function exists globally before calling
            if (typeof filterByStatus === "function") {
                filterByStatus(remembered);
            }
        }
    });
</script>