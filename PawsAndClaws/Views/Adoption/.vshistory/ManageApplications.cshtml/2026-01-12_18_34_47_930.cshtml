@model PawsAndClaws.Models.ViewModels.ApplicationPageViewModel

@{
    ViewData["Title"] = "Manage Applications";
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header Section -->
    <div class="mb-10">
        <h1 class="text-4xl font-black text-[#2D2D2D] mb-2" style="font-family: 'Lilita One', cursive;">
            <span class="text-[#F87004]">Applications</span> <span class="text-[#56C2B1]">Management</span>
        </h1>
        <p class="text-gray-600 font-medium">Review and process adoption requests from users.</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
        <div class="relative">
            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
            <input type="text"
                   id="searchApplications"
                   placeholder="Search name or breed..."
                   class="w-full pl-12 pr-6 py-4 bg-gray-50 border border-gray-200 rounded-full text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#56C2B1]/20 focus:border-[#56C2B1] transition-all" />
        </div>
    </div>

    <!-- Filter Section with Count -->
    <div class="mb-8 flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-2">
            <h3 class="text-lg font-bold text-[#2D2D2D]">All Pets</h3>
            <span class="bg-[#F87004] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">
                @Model.StatusCounts["All"]
            </span>
        </div>

        <!-- Filter Group Component -->
        <partial name="_ApplicationFilter" model="Model.StatusCounts" />
    </div>

    <!-- Applications Table -->
    <div class="bg-white border border-gray-100 rounded-2xl overflow-hidden shadow-sm">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-100 bg-gray-50">
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Applicant</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Applying For</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Status</th>
                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-400 uppercase tracking-widest">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Applications.Any())
                {
                    @foreach (var app in Model.Applications)
                    {
                        // adjust if your statuses differ
                        var isLocked = string.Equals(app.Status, "APPROVED", StringComparison.OrdinalIgnoreCase);

                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                            <!-- Applicant Column -->
                            <td class="px-6 py-5">
                                <p class="text-sm font-bold text-[#2D2D2D]">@app.ApplicantName</p>
                            </td>

                            <!-- Applying For Column -->
                            <td class="px-6 py-5">
                                <div class="flex items-center gap-3">
                                    <img src="@app.ImageUrl" alt="@app.PetName" class="w-10 h-10 rounded-full object-cover" />
                                    <div>
                                        <p class="text-sm font-bold text-[#2D2D2D]">@app.PetName</p>
                                    </div>
                                </div>
                            </td>

                            <!-- Status Column -->
                            <td class="px-6 py-5">
                                @{
                                    var badgeVariant = (app.Status ?? "").ToUpperInvariant() switch
                                    {
                                        "PENDING" => "warning",
                                        "APPROVED" => "secondary",
                                        "REJECTED" => "danger",
                                        "CANCELLED" => "neutral",
                                        _ => "secondary"
                                    };
                                }
                                <partial name="_Badge" model="new BadgeViewModel { Text = app.Status, Variant = badgeVariant }" />
                            </td>

                            <!-- Action Column -->
                            <td class="px-6 py-5 text-right">
                                @if (isLocked)
                                {
                                    <button type="button"
                                            disabled
                                            class="px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest bg-gray-100 text-gray-400 cursor-not-allowed opacity-60">
                                        Manage
                                    </button>
                                }
                                else
                                {
                                    <button type="button"
                                            onclick="openManageApplicationModal(@app.ApplicationId)"
                                            class="px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white shadow-md shadow-orange-100 hover:scale-[1.02] active:scale-[0.98]">
                                        Manage
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <p class="text-gray-400 text-sm">No applications found for this filter.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* ? Render a modal PER application (not just First()) *@
@if (Model.Applications.Any())
{
    foreach (var app in Model.Applications)
    {
        <partial name="_ManageApplicationModal" model="app" />
    }
}

@section Scripts {
    <script>
        function openManageApplicationModal(appId) {
            const modal = document.getElementById(`manageApplicationModal-${appId}`);
            if (modal) {
                modal.classList.remove('hidden');
                if (window.lucide) lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Setup each modal independently (no collisions)
            document.querySelectorAll('[id^="manageApplicationModal-"]').forEach(modal => {
                const closeBtns = modal.querySelectorAll('[data-close-manage-modal]');
                const statusBtns = modal.querySelectorAll('.status-btn');
                const statusInput = modal.querySelector('input[name="Status"]');
                const stageCards = modal.querySelectorAll('.stage-card');
                const stageInput = modal.querySelector('input[name="CurrentStep"]');

                const closeModal = () => modal.classList.add('hidden');

                closeBtns.forEach(b => b.addEventListener('click', closeModal));

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                // Status selection: only one active
                statusBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        statusBtns.forEach(b => {
                            b.classList.remove('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');
                            b.classList.add('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');
                        });

                        btn.classList.remove('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');
                        btn.classList.add('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');

                        if (statusInput) statusInput.value = btn.dataset.status || "";
                    });
                });

                // Stage selection: green past, orange current, gray future
                stageCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const selectedIdx = parseInt(card.dataset.stage || "1");
                        if (stageInput) stageInput.value = selectedIdx;

                        stageCards.forEach(other => {
                            const currentIdx = parseInt(other.dataset.stage || "1");
                            const iconContainer = other.querySelector('.stage-icon-container');
                            const labelSm = other.querySelector('.stage-label-sm');
                            const labelLg = other.querySelector('.stage-label-lg');

                            if (!iconContainer || !labelSm || !labelLg) return;

                            if (currentIdx < selectedIdx) {
                                other.className = "stage-card border-2 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300 border-[#50B442] bg-[#50B442]/5";
                                labelSm.className = "stage-label-sm text-[10px] font-black uppercase tracking-widest text-[#50B442]";
                                labelLg.className = "stage-label-lg text-sm font-bold text-[#50B442]";
                                iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center bg-[#50B442]";
                                iconContainer.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';
                            } else if (currentIdx === selectedIdx) {
                                other.className = "stage-card border-2 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300 border-[#F87004] bg-[#F87004]/5";
                                labelSm.className = "stage-label-sm text-[10px] font-black uppercase tracking-widest text-[#F87004]";
                                labelLg.className = "stage-label-lg text-sm font-bold text-[#F87004]";
                                iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-[#F87004]";
                                iconContainer.innerHTML = '<div class="w-4 h-4 rounded-full bg-[#F87004]"></div>';
                            } else {
                                other.className = "stage-card border-2 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300 border-gray-200 bg-gray-50";
                                labelSm.className = "stage-label-sm text-[10px] font-black uppercase tracking-widest text-gray-400";
                                labelLg.className = "stage-label-lg text-sm font-bold text-gray-400";
                                iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300";
                                iconContainer.innerHTML = '<div class="w-3 h-3 rounded-full bg-gray-300"></div>';
                            }
                        });

                        if (window.lucide) lucide.createIcons();
                    });
                });
            });
        });
    </script>
}