@using PawsAndClaws.Models.ViewModels
@model PawsAndClaws.Models.ViewModels.ApplicationPageViewModel

@{
    ViewData["Title"] = "Manage Applications";
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header Section -->
    <div class="mb-10">
        <h1 class="text-4xl font-black text-[#2D2D2D] mb-2" style="font-family: 'Lilita One', cursive;">
            <span class="text-[#F87004]">Applications</span> <span class="text-[#56C2B1]">Management</span>
        </h1>
        <p class="text-gray-600 font-medium">Review and process adoption requests from users.</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
        <div class="relative">
            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
            <input type="text"
                   id="searchApplications"
                   placeholder="Search name or breed..."
                   class="w-full pl-12 pr-6 py-4 bg-gray-50 border border-gray-200 rounded-full text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#56C2B1]/20 focus:border-[#56C2B1] transition-all" />
        </div>
    </div>

    <!-- Filter Section with Count -->
    <div class="mb-8 flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-2">
            <h3 class="text-lg font-bold text-[#2D2D2D]">All Pets</h3>
            <span class="bg-[#F87004] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">
                @Model.StatusCounts["All"]
            </span>
        </div>

        <partial name="_ApplicationFilter" model="Model.StatusCounts" />
    </div>

    <!-- Applications Table -->
    <div class="bg-white border border-gray-100 rounded-2xl overflow-hidden shadow-sm">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-100 bg-gray-50">
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Applicant</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Applying For</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Status</th>
                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-400 uppercase tracking-widest">Action</th>
                </tr>
            </thead>

            <tbody>
                
                @if (Model.Applications.Any())
                {
                    foreach (var app in Model.Applications)
                    {
                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-5">
                                <p class="text-sm font-bold text-[#2D2D2D]">@app.ApplicantName</p>
                            </td>

                            <td class="px-6 py-5">
                                <div class="flex items-center gap-3">
                                    <img src="@app.ImageUrl" class="w-10 h-10 rounded-full object-cover" />
                                    <p class="text-sm font-bold text-[#2D2D2D]">@app.PetName</p>
                                </div>
                            </td>

                            <td class="px-6 py-5">
                                <partial name="_Badge" model='@(new BadgeViewModel { Text = app.Status, Variant = "warning" })' />
                            </td>

                            <td class="px-6 py-5 text-right">
                                <button type="button"
                                        class="px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest bg-gradient-to-r from-[#F87004] to-[#FFB347] text-white"
                                        onclick="openManageApplicationModal(@app.ApplicationId)">
                                    Manage
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <p class="text-gray-400 text-sm">No applications found for this filter.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        @* Render modals OUTSIDE the table (important!) *@
        @if (Model.Applications.Any())
        {
            foreach (var app in Model.Applications)
            {
                <partial name="_ManageApplicationModal" model="app" />
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        function applyStatusUI(modal, status) {
            const statusBtns = modal.querySelectorAll('.status-btn');
            const statusInput = modal.querySelector('input[name="Status"]');
            const target = (status || '').toLowerCase();

            if (statusInput) statusInput.value = status || '';

            statusBtns.forEach(btn => {
                const isActive = (btn.dataset.status || '').toLowerCase() === target;

                btn.classList.remove('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');
                btn.classList.add('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');

                if (isActive) {
                    btn.classList.remove('text-gray-400', 'hover:text-gray-600', 'hover:bg-gray-50');
                    btn.classList.add('bg-gradient-to-r', 'from-[#F87004]', 'to-[#FFB347]', 'text-white', 'shadow-md', 'shadow-orange-100');
                }
            });
        }

        function applyStageUI(modal, selectedIdx) {
            const stageCards = modal.querySelectorAll('.stage-card');
            const stageInput = modal.querySelector('input[name="CurrentStep"]');
            const step = parseInt(selectedIdx || "1", 10);

            if (stageInput) stageInput.value = step;

            stageCards.forEach(card => {
                const currentIdx = parseInt(card.dataset.stage || "1", 10);
                const iconContainer = card.querySelector('.stage-icon-container');
                const labelSm = card.querySelector('.stage-label-sm');
                const labelLg = card.querySelector('.stage-label-lg');
                if (!iconContainer || !labelSm || !labelLg) return;

                if (currentIdx < step) {
                    card.className = "stage-card border-2 border-[#50B442] bg-[#50B442]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                    labelSm.className = "stage-label-sm text-[10px] font-black text-[#50B442] uppercase tracking-widest";
                    labelLg.className = "stage-label-lg text-sm font-bold text-[#50B442]";
                    iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center bg-[#50B442]";
                    iconContainer.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';
                } else if (currentIdx === step) {
                    card.className = "stage-card border-2 border-[#F87004] bg-[#F87004]/5 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                    labelSm.className = "stage-label-sm text-[10px] font-black text-[#F87004] uppercase tracking-widest";
                    labelLg.className = "stage-label-lg text-sm font-bold text-[#F87004]";
                    iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-[#F87004]";
                    iconContainer.innerHTML = '<div class="w-4 h-4 rounded-full bg-[#F87004]"></div>';
                } else {
                    card.className = "stage-card border-2 border-gray-200 bg-gray-50 rounded-2xl p-5 flex flex-col items-center gap-2 transition-all duration-300";
                    labelSm.className = "stage-label-sm text-[10px] font-black text-gray-400 uppercase tracking-widest";
                    labelLg.className = "stage-label-lg text-sm font-bold text-gray-400";
                    iconContainer.className = "stage-icon-container w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-300";
                    iconContainer.innerHTML = '<div class="w-3 h-3 rounded-full bg-gray-300"></div>';
                }
            });

            if (window.lucide) lucide.createIcons();
        }

        function openModalByAppId(appId) {
            const modal = document.getElementById(`manageApplicationModal-${appId}`);
            if (!modal) return;

            modal.classList.remove('hidden');

            // sync buttons from hidden inputs on open
            const status = modal.querySelector('input[name="Status"]')?.value || "Pending";
            const step = modal.querySelector('input[name="CurrentStep"]')?.value || "1";

            applyStatusUI(modal, status);
            applyStageUI(modal, step);

            if (window.lucide) lucide.createIcons();
        }

        document.addEventListener('click', (e) => {
            // OPEN
            const openBtn = e.target.closest('[data-open-manage]');
            if (openBtn) {
                openModalByAppId(openBtn.dataset.appId);
                return;
            }

            // CLOSE (X or Cancel)
            const closeBtn = e.target.closest('[data-close-manage-modal]');
            if (closeBtn) {
                const modal = closeBtn.closest('[id^="manageApplicationModal-"]');
                modal?.classList.add('hidden');
                return;
            }

            // Backdrop click close
            const modalBackdrop = e.target.closest('[id^="manageApplicationModal-"]');
            if (modalBackdrop && e.target === modalBackdrop) {
                modalBackdrop.classList.add('hidden');
                return;
            }

            // STATUS click
            const statusBtn = e.target.closest('.status-btn');
            if (statusBtn) {
                const modal = statusBtn.closest('[id^="manageApplicationModal-"]');
                if (!modal) return;
                applyStatusUI(modal, statusBtn.dataset.status);
                return;
            }

            // STAGE click
            const stageCard = e.target.closest('.stage-card');
            if (stageCard) {
                const modal = stageCard.closest('[id^="manageApplicationModal-"]');
                if (!modal) return;
                applyStageUI(modal, stageCard.dataset.stage);
                return;
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('[id^="manageApplicationModal-"]:not(.hidden)')
                    .forEach(m => m.classList.add('hidden'));
            }
        });
    </script>
}