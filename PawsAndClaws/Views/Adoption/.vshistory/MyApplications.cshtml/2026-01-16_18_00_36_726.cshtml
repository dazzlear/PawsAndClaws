@model PawsAndClaws.Models.ViewModels.ApplicationPageViewModel

@{
    ViewData["Title"] = "My Applications";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 rounded-2xl border border-green-200 bg-green-50 px-5 py-4 text-green-800 text-sm font-semibold">
        @TempData["SuccessMessage"]
    </div>
}

<div class="bg-[#FFFAF7] min-h-screen pb-20 font-sans">
    <div class="max-w-7xl mx-auto px-4 py-12">
        
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-16 gap-6">
            <div>
                <h1 class="text-6xl font-bold text-[#2D2D2D] font-lilita" style="font-family: 'Lilita One', cursive;">
                    <span class="text-[#F87004]">Welcome</span> <span class="text-[#56C2B1]">back,</span> @Model.UserName!
                </h1>
                <p class="text-gray-500 font-medium mt-2">Track the progress of your applications and manage your shelter visits.</p>
            </div>

            <partial name="_ShelterVisitCard" model="Model.Visits.FirstOrDefault()" />
        </div>

        <div class="mb-20">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-bold text-[#2D2D2D] flex items-center gap-3">
                    Your Applications 
                    <span class="bg-[#F87004] text-white text-xs px-3 py-2 rounded-full">@Model.StatusCounts["All"]</span>
                </h2>
                <partial name="_ApplicationFilter" model='Model.StatusCounts' />
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                @foreach (var app in Model.Applications) {
                    <partial name="_ApplicationCard" model="app" />
                }
            </div>
        </div>

    </div>
</div>


<div id="cancelAppModal"
     class="fixed inset-0 z-[99999] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm px-4 pointer-events-auto">
    <div class="relative z-[100000] bg-white rounded-[32px] w-full max-w-md shadow-2xl overflow-hidden pointer-events-auto">
       
        <div class="p-7 border-b border-gray-50 flex items-center justify-between">
            <h3 class="text-xl font-black text-[#2D2D2D]" style="font-family:'Lilita One', cursive;">
                Cancel <span class="text-[#F87004]">application</span>?
            </h3>
            <button type="button" id="cancelAppClose" class="p-2 hover:bg-gray-100 rounded-full text-gray-400">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-7 text-sm text-gray-600 font-medium">
            Are you sure you want to cancel your application for
            <span id="cancelAppPetName" class="font-bold text-[#2D2D2D]">this pet</span>?
        </div>

        <div class="p-7 pt-0 flex gap-3">
            <button type="button" id="cancelAppNo"
                    class="flex-1 py-3 rounded-full border border-gray-200 text-gray-500 text-xs font-black uppercase tracking-widest hover:bg-gray-50">
                No, keep it
            </button>

            <button type="button" id="cancelAppYes"
                    class="flex-1 py-3 rounded-full bg-gradient-to-r from-[#F87004] to-[#FBBF24] text-white text-xs font-black uppercase tracking-widest shadow-lg shadow-orange-100 pointer-events-auto">
                Yes, cancel
            </button>
        </div>
    </div>
</div>

<form id="antiForgeryForm" class="hidden">
    @Html.AntiForgeryToken()
</form>

<script>

    const cancelEndpoint = '@Url.Action("CancelApplication", "Adoption")';

    function getAntiForgeryToken() {
      return document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value || "";
    }

    function closeAllDropdowns() {
      document.querySelectorAll(".dropdown-menu").forEach(m => m.classList.add("hidden"));
    }

    // modal elements
    const cancelModal = document.getElementById("cancelAppModal");
    const cancelPetName = document.getElementById("cancelAppPetName");
    const btnClose = document.getElementById("cancelAppClose");
    const btnNo = document.getElementById("cancelAppNo");
    const btnYes = document.getElementById("cancelAppYes");

    let pendingCancelAppId = null;

    function openCancelModal(appId, petName) {
      pendingCancelAppId = appId;
      if (cancelPetName) cancelPetName.textContent = petName || "this pet";
      cancelModal?.classList.remove("hidden");
      if (typeof lucide !== "undefined") lucide.createIcons();
    }

    function closeCancelModal() {
      pendingCancelAppId = null;
      cancelModal?.classList.add("hidden");
    }


    btnClose?.addEventListener("click", closeCancelModal);
    btnNo?.addEventListener("click", closeCancelModal);

    // close on backdrop click
    document.addEventListener("click", (e) => {
      if (cancelModal && e.target === cancelModal) closeCancelModal();
    });

    // ===== Open modal when clicking "Cancel Application" in dropdown =====
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".cancel-application-btn");
      if (!btn) return;

      e.preventDefault();
      closeAllDropdowns();
      
      const petName = btn.dataset.petName;

        const rawId = btn.dataset.applicationId;
        console.log("Cancel clicked id:", rawId);

        const appId = parseInt(rawId, 10);
        console.log("Parsed appId:", appId);console.log("Cancel clicked. applicationId =", appId);

    
      openCancelModal(appId, petName);
    });

    // ===== YES cancel -> POST to controller =====
    btnYes?.addEventListener("click", async () => {
      if (!pendingCancelAppId) return;

      const token = getAntiForgeryToken();
      if (!token) {
        console.error("Missing anti-forgery token on page.");
        alert("Failed to cancel application.");
        return;
      }

      
      try {
        const body = new URLSearchParams();
        body.append("id", String(pendingCancelAppId));
        body.append("__RequestVerificationToken", token);

        const res = await fetch(cancelEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
          body: body.toString(),
          credentials: "same-origin"
        });

        if (!res.ok) {
          const raw = await res.text();
          alert(`Failed: ${res.status} ${raw}`);
          return;
        }

        closeCancelModal();

        // ✅ move to cancelled tab after reload
        localStorage.setItem("applicationsFilter", "CANCELLED");
        location.reload();

      } catch (err) {
        console.error(err);
        alert("Failed to cancel application.");
      }
    });

    // ===== After reload, auto switch filter if your filter JS exists =====
    document.addEventListener("DOMContentLoaded", () => {
      const remembered = localStorage.getItem("applicationsFilter");
      if (remembered) {
        localStorage.removeItem("applicationsFilter");
        if (typeof filterByStatus === "function") filterByStatus(remembered);
      }
    });
</script>